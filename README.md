A fixed version of this gist

https://gist.github.com/hepteract/8d9199a6a154dd32a1c4ced97de76043